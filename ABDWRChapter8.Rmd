---
title: "ABDWRChapter8"
output: html_document
---


```{r}
library(tidyverse)
library(Lahman)
library(brms)

batting <- Batting |>
  replace_na(list(SF = 0, HBP = 0))

get_stats <- function(player_id) {
  batting |> 
    filter(playerID == player_id) |>
    inner_join(People, by = "playerID") |>
    mutate(
      birthyear = if_else(
        birthMonth >= 7, birthYear + 1, birthYear
      ),
      Age = yearID - birthyear,
      SLG = (H - X2B - X3B - HR + 2 * X2B + 3 * X3B + 4 * HR) / AB,
      OBP = (H + BB + HBP) / (AB + BB + HBP + SF),
      OPS = SLG + OBP
    ) |>
    select(Age, SLG, OBP, OPS)
}

```



### Computing trajectories 

```{r}
batting_2000 <- batting |> 
  group_by(playerID) |>
  summarize(AB_career = sum(AB, na.rm = TRUE)) |>
  inner_join(batting, by = "playerID") |>
  filter(AB_career >= 2000)


Positions <- Fielding |> 
  group_by(playerID, POS) |>
  summarize(Games = sum(G)) |> 
  arrange(playerID, desc(Games)) |> 
  filter(POS == first(POS))

batting_2000 <- batting_2000 |>
  inner_join(Positions, by = "playerID")





batting_2000 <- batting_2000 |> 
  group_by(playerID, yearID) |>
  summarize(
    G = sum(G), AB = sum(AB), R = sum(R),
    H = sum(H), X2B = sum(X2B), X3B = sum(X3B),
    HR = sum(HR), RBI = sum(RBI), SB = sum(SB),
    CS = sum(CS), BB = sum(BB), SH = sum(SH),
    SF = sum(SF), HBP = sum(HBP),
    AB_career = first(AB_career),
    POS = first(POS)
  ) |>
  mutate(
    SLG = (H - X2B - X3B - HR + 2 * X2B + 3 * X3B + 4 * HR) / AB,
    OBP = (H + BB + HBP) / (AB + BB + HBP + SF),
    OPS = SLG + OBP
  )
batting_2000 <- batting_2000 |>
  inner_join(People, by = "playerID") |>
  mutate(
    Birthyear = if_else(
      birthMonth >= 7, birthYear + 1, birthYear
    ),
    Age = yearID - Birthyear
  )

batting_2000 |> drop_na(Age) -> batting_2000


not_current_playerID <- People |>
  filter(finalGame < "2021-11-01") |> 
  pull(playerID)

batting_2000 <- batting_2000 |>
  filter(playerID %in% not_current_playerID)

```


```{r}
midcareers <- batting_2000 |>
  group_by(playerID) |>
  summarize(
    Midyear = (min(yearID) + max(yearID)) / 2,
    AB_total = first(AB_career)
  )
batting_2000 <- batting_2000 |>
  inner_join(midcareers, by = "playerID")

```



### Fielding pos

```{r}
batting_2000a <- batting_2000 |>
  filter(Midyear >= 1985, Midyear <= 1995) |> ungroup() 

batting_2000a <- batting_2000a |>
    mutate(age_c = (Age - 30)/20)|> 
     select(OPS, playerID, Age, age_c, POS) |> drop_na()
```



```{r}
fit_player <- brm(
  OPS ~ age_c + I(age_c^2) + (age_c + I(age_c^2) | playerID),
  data = batting_2000a,
  cores = 4, iter = 2000,
  family = 'student',
  control = list(adapt_delta = 0.95)
)
```

```{r}

# Posterior predictive check
pp_check(fit_player)
```

```{r}
posterior_player <- as_draws_df(fit_player)
# Compute peak ages per player

player_peak_ages <- posterior_player |>
  select(starts_with("r_playerID"), b_age_c, b_Iage_cE2) |>
  pivot_longer(cols = starts_with("r_playerID"),
               names_to = c("playerID", "param"),
               names_pattern = "r_playerID\\[(.*?),(.*?)\\]") |>
  pivot_wider(names_from = param, values_from = value) |>
  mutate(
    linear_total = b_age_c + age_c,
    quad_total = b_Iage_cE2 + Iage_cE2,
    peak_age = 30 - 10*(linear_total / (2 * quad_total))
  ) %>%
  group_by(playerID) %>%
  summarize(
    peak_age_median = median(peak_age),
    peak_age_lower = quantile(peak_age, 0.25),
    peak_age_upper = quantile(peak_age, 0.75)
  )  

player_peak_ages <- player_peak_ages %>%
  left_join(batting_2000a %>% select(playerID, POS) %>% distinct(), by = "playerID")
```

```{r}


# Plot strip plot grouped by position
ggplot(player_peak_ages, aes(x = POS, y = peak_age_median)) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  #geom_errorbar(
  #  aes(ymin = peak_age_lower, ymax = peak_age_upper),
  #  width = 0.1, alpha = 0.4, color = "gray40"
  #) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  labs(title = "Player Peak Ages Grouped by Position", 
       x = "Position", y = "Peak Age") +
  #scale_y_continuous(limits = c(20,50)) +
  theme_minimal()
```

With error bars 

```{r}
# jitter by hand
player_peak_ages <- player_peak_ages %>%
  mutate(POS_jitter = as.numeric(factor(POS)) + runif(n(), -0.15, 0.15))

ggplot(player_peak_ages, aes(x = POS_jitter, y = peak_age_median)) +
  geom_point(alpha = 0.6, color = "blue", size = 1.5) +
  geom_errorbar(
    aes(ymin = peak_age_lower, ymax = peak_age_upper),
    width = 0.0, alpha = 0.4, color = "gray40"
  ) +
  scale_x_continuous(
    breaks = 1:length(unique(player_peak_ages$POS)),
    labels = sort(unique(player_peak_ages$POS))
  ) +
 
  labs(title = "Player Peak Ages Grouped by Position (with uncertainty)", 
       x = "Position", y = "Peak Age") +
  theme_minimal()
```

```{r}
# Select 4 random players
set.seed(123)
selected_players <- sample(unique(batting_2000a$playerID), 4)

 
age_seq <- seq(20, 50, length.out = 50)
plot_data <- expand.grid(playerID = selected_players, Age = age_seq) %>%
  mutate(age_c = (Age - 30)/20)

# Get linear predictor predictions (30 draws)
linpred_matrix <- posterior_linpred(fit_player, newdata = plot_data, ndraws = 30)

 
pred_df <- plot_data %>%
  mutate(row = row_number()) %>%
  left_join(
    as.data.frame(t(linpred_matrix)) %>%
      mutate(row = row_number()) %>%
      pivot_longer(-row, names_to = "draw", values_to = "OPS_pred"),
    by = "row"
  )

 
actual_df <- batting_2000a %>%
  filter(playerID %in% selected_players)

 
ggplot() +
  geom_point(data = actual_df, aes(x = Age, y = OPS), color = "black") +
  geom_line(data = pred_df, aes(x = Age, y = OPS_pred, group = draw), 
            color = "blue", alpha = 0.3) +
  facet_wrap(~playerID, scales = "free") +
  labs(title = "Smooth Fitted OPS curves (30 posterior draws) vs. Actual Data",
       x = "Age",
       y = "OPS") +
  theme_minimal()

```

## Nonlinear 

```{r}
nlform <- bf(
  OPS ~ peakOPS - gamma * ((Age - peakAge)/10)^2,
  peakOPS + peakAge + gamma ~ 1 + (1 | playerID),
  nl = TRUE
)

# Set informative priors
priors <- c(
  prior(normal(0.75, 0.1), nlpar = "peakOPS", lb = 0.5, ub = 2),
  prior(normal(30, 5), nlpar = "peakAge", lb = 10, ub = 60),
  prior(exponential(1), nlpar = "gamma", lb = 0)
)

fit_peak <- brm(
  nlform,
  data = batting_2000a,
  prior = priors,
  cores = 4,
  iter = 4000,
  family = student(),
  control = list(adapt_delta = 0.95)
)
```

```{r}
pp_check(fit_peak)
```


Plot 

```{r}
# Select 4 random players (use same players as earlier for consistency)
set.seed(123)
selected_players <- sample(unique(batting_2000a$playerID), 4)
 
age_seq <- seq(min(batting_2000a$Age), max(batting_2000a$Age), length.out = 50)
plot_data <- expand.grid(playerID = selected_players, Age = age_seq)

epreds <- posterior_epred(fit_peak, newdata = plot_data, ndraws = 30)

pred_df <- plot_data %>%
  mutate(row = row_number()) %>%
  left_join(
    as.data.frame(t(epreds)) %>%
      mutate(row = row_number()) %>%
      pivot_longer(-row, names_to = "draw", values_to = "OPS_pred"),
    by = "row"
  )

 
actual_df <- batting_2000a %>%
  filter(playerID %in% selected_players)
 
ggplot() +
  geom_point(data = actual_df, aes(x = Age, y = OPS), color = "black") +
  geom_line(data = pred_df, aes(x = Age, y = OPS_pred, group = draw),
            color = "blue", alpha = 0.3) +
  facet_wrap(~playerID, scales = "free") +
  labs(title = "Posterior OPS predictions vs. Actual Data",
       subtitle = "30 posterior draws using stable peak-age parameterization",
       x = "Age",
       y = "OPS") +
  theme_minimal()

```



## TESTING


Simple test of hierarchical peak model


Fake data:
```{r}
library(brms)
library(dplyr)
library(tidyverse)

# Set seed
set.seed(123)

 
n_positions <- 8
positions <- paste0("Pos", 1:n_positions)
n_players <- 80

# True position-specific parameters
true_intercepts <- rnorm(n_positions, 0.75, 0.05)
true_linear_age <- rnorm(n_positions, 0.01, 0.005)
true_quad_age <- rnorm(n_positions, -0.002, 0.0005)

# Expand each player across ages 20 to 40
fake_data <- expand.grid(
  player = 1:n_players,
  age = 20:40
) %>%
  mutate(
    position = sample(positions, n_players, replace = TRUE)[player],
    pos_idx = match(position, positions),
    age_c = age - 30,
    ops = true_intercepts[pos_idx] + 
          true_linear_age[pos_idx] * age_c + 
          true_quad_age[pos_idx] * age_c^2 + 
          rnorm(n(), 0, 0.02)
  )
```

Example

```{r}
random_player <- sample(unique(fake_data$player), 1)
fake_data %>%
  filter(player == random_player) %>%
  ggplot(aes(x = age, y = ops)) +
  geom_point() +
  geom_line() +
  labs(title = paste("OPS vs Age for Player", random_player),
       x = "Age", y = "OPS")
```


fit model

```{r}
# Fit hierarchical model
fit_player <- brm(
  ops ~ age_c + I(age_c^2) + (age_c + I(age_c^2) | player),
  data = fake_data,
  cores = 4, iter = 2000,
  control = list(adapt_delta = 0.95)
)
summary(fit)

# Posterior predictive check
pp_check(fit)
```


Compute each player peak ages

```{r}

posterior_player <- as_draws_df(fit_player)

# Compute peak ages per player
player_peak_ages <- posterior_player %>%
  select(starts_with("r_player"), b_age_c, b_Iage_cE2) %>%
  pivot_longer(cols = starts_with("r_player"), names_to = c("player", "param"),
               names_pattern = "r_player\\[(.*?),(.*?)\\]") %>%
  pivot_wider(names_from = param, values_from = value) %>%
  mutate(
    linear_total = b_age_c + age_c,
    quad_total = b_Iage_cE2 + Iage_cE2,
    peak_age = 30 - (linear_total / (2 * quad_total))
  ) %>%
  group_by(player) %>%
  summarize(
    peak_age_mean = mean(peak_age),
    peak_age_lower = quantile(peak_age, 0.025),
    peak_age_upper = quantile(peak_age, 0.975)
  ) %>%
  mutate(player = as.integer(player))

```


And plot
```{r}
player_peak_ages <- player_peak_ages %>%
  left_join(fake_data %>% select(player, position) %>% distinct(), by = "player")

# Plot strip plot grouped by position
ggplot(player_peak_ages, aes(x = position, y = peak_age_mean)) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  geom_boxplot(alpha = 0.3, outlier.shape = NA) +
  labs(title = "Player Peak Ages Grouped by Position", 
       x = "Position", y = "Peak Age") +
  theme_minimal()
``` 


CONSIDER: look at coefficients of sample and see if we can just use random slopes.  Still changes peak age.
(Check standard deviation of quadratic term)


or maybe? random slope for position?
```{r}
fit_player <- brm(
  ops ~ age_c + I(age_c^2) + 
    (age_c  | position) + 
    (age_c + I(age_c^2) | player),
  data = fake_data,
  cores = 4, iter = 3000,
  control = list(adapt_delta = 0.95)
)
```
